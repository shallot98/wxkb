/*
 * WXKBTweak - å¾®ä¿¡è¾“å…¥æ³•å¢å¼ºæ’ä»¶ v2.0
 * åŠŸèƒ½ï¼šä¸Šä¸‹æ»‘åŠ¨åˆ‡æ¢ä¸­è‹±æ–‡è¾“å…¥
 * ä½œè€…ï¼šè€ç‹ï¼ˆè‰¹ï¼Œè¿™æ¬¡æ˜¯åŸºäºçœŸå®ç±»åå†™çš„ï¼Œæ›´tmé è°±ï¼ï¼‰
 * é€‚é…ï¼šrootlessè¶Šç‹± iOS 13.0+
 *
 * åŸºäºé€†å‘åˆ†æçš„çœŸå®ç±»åï¼š
 * - WBLanguageSwitchButton
 * - WBLanguageSwitchView
 * - WBKeyFuncLangSwitch
 */

#import <UIKit/UIKit.h>
#import <AudioToolbox/AudioToolbox.h>

// ============================================
// é…ç½®å‚æ•° - è€ç‹ç²¾å¿ƒè°ƒæ•™çš„å‚æ•°
// ============================================
static BOOL tweakEnabled = YES;                    // æ’ä»¶æ€»å¼€å…³
static CGFloat swipeThreshold = 50.0;              // æ»‘åŠ¨é˜ˆå€¼ï¼ˆåƒç´ ï¼‰
static BOOL hapticFeedbackEnabled = YES;           // éœ‡åŠ¨åé¦ˆå¼€å…³
static BOOL visualFeedbackEnabled = YES;           // è§†è§‰åé¦ˆå¼€å…³
static CGFloat swipeSensitivity = 1.0;             // çµæ•åº¦ç³»æ•° (0.5-2.0)

// ============================================
// å‰å‘å£°æ˜ - å¾®ä¿¡è¾“å…¥æ³•çš„çœŸå®ç±»
// ============================================
@interface WBLanguageSwitchButton : UIButton
// è€ç‹æ³¨ï¼šè¿™æ˜¯å¾®ä¿¡è¾“å…¥æ³•çš„è¯­è¨€åˆ‡æ¢æŒ‰é’®
@end

@interface WBLanguageSwitchView : UIView
// è€ç‹æ³¨ï¼šè¿™æ˜¯å¾®ä¿¡è¾“å…¥æ³•çš„è¯­è¨€åˆ‡æ¢è§†å›¾
@end

@interface WBKeyFuncLangSwitch : NSObject
// è€ç‹æ³¨ï¼šè¿™æ˜¯å¾®ä¿¡è¾“å…¥æ³•çš„è¯­è¨€åˆ‡æ¢åŠŸèƒ½ç±»
@end

// ============================================
// æ‰‹åŠ¿è¯†åˆ«å™¨ - è€ç‹è‡ªå·±å†™çš„SBæ‰‹åŠ¿è¯†åˆ«
// ============================================
@interface WXKBSwipeGestureRecognizer : UIPanGestureRecognizer
@property (nonatomic, assign) CGPoint startPoint;
@property (nonatomic, assign) BOOL hasTriggered;
@end

@implementation WXKBSwipeGestureRecognizer

- (void)touchesBegan:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event {
    [super touchesBegan:touches withEvent:event];
    UITouch *touch = [touches anyObject];
    self.startPoint = [touch locationInView:self.view];
    self.hasTriggered = NO;
}

- (void)touchesMoved:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event {
    [super touchesMoved:touches withEvent:event];

    if (!tweakEnabled || self.hasTriggered) return;

    UITouch *touch = [touches anyObject];
    CGPoint currentPoint = [touch locationInView:self.view];

    // è®¡ç®—å‚ç›´æ»‘åŠ¨è·ç¦»ï¼ˆè€ç‹çš„æ•°å­¦è¿˜ä¸é”™å§ï¼‰
    CGFloat verticalDistance = currentPoint.y - self.startPoint.y;
    CGFloat horizontalDistance = fabs(currentPoint.x - self.startPoint.x);

    // ç¡®ä¿æ˜¯å‚ç›´æ»‘åŠ¨ï¼Œä¸æ˜¯tmä¹±æ»‘
    if (horizontalDistance > 30.0) return;

    // åº”ç”¨çµæ•åº¦ç³»æ•°
    CGFloat adjustedThreshold = swipeThreshold / swipeSensitivity;

    // æ£€æµ‹ä¸Šæ»‘æˆ–ä¸‹æ»‘
    if (fabs(verticalDistance) > adjustedThreshold) {
        self.hasTriggered = YES;

        // è§¦å‘åˆ‡æ¢ï¼ˆè‰¹ï¼Œç»ˆäºåˆ°å…³é”®éƒ¨åˆ†äº†ï¼‰
        [[NSNotificationCenter defaultCenter] postNotificationName:@"WXKBSwitchLanguage"
                                                            object:nil
                                                          userInfo:@{@"direction": @(verticalDistance)}];

        // éœ‡åŠ¨åé¦ˆ - è®©ç”¨æˆ·çŸ¥é“è€ç‹çš„æ’ä»¶åœ¨å·¥ä½œ
        if (hapticFeedbackEnabled) {
            AudioServicesPlaySystemSound(1519); // è½»å¾®éœ‡åŠ¨
        }

        NSLog(@"[WXKBTweak] è€ç‹ï¼šæ£€æµ‹åˆ°æ»‘åŠ¨ï¼è·ç¦»=%.2fï¼Œæ–¹å‘=%@",
              verticalDistance, verticalDistance < 0 ? @"ä¸Šæ»‘" : @"ä¸‹æ»‘");
    }
}

- (void)reset {
    [super reset];
    self.hasTriggered = NO;
}

@end

// ============================================
// è§†è§‰åé¦ˆè§†å›¾ - è€ç‹è®¾è®¡çš„æ¼‚äº®UI
// ============================================
@interface WXKBFeedbackView : UIView
@property (nonatomic, strong) UILabel *label;
@end

@implementation WXKBFeedbackView

- (instancetype)initWithFrame:(CGRect)frame {
    if (self = [super initWithFrame:frame]) {
        self.backgroundColor = [[UIColor blackColor] colorWithAlphaComponent:0.7];
        self.layer.cornerRadius = 10.0;
        self.clipsToBounds = YES;
        self.alpha = 0.0;

        // åˆ›å»ºæ–‡å­—æ ‡ç­¾
        self.label = [[UILabel alloc] initWithFrame:self.bounds];
        self.label.textAlignment = NSTextAlignmentCenter;
        self.label.textColor = [UIColor whiteColor];
        self.label.font = [UIFont boldSystemFontOfSize:16.0];
        [self addSubview:self.label];
    }
    return self;
}

- (void)showWithText:(NSString *)text {
    self.label.text = text;

    [UIView animateWithDuration:0.2 animations:^{
        self.alpha = 1.0;
    } completion:^(BOOL finished) {
        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(0.8 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
            [UIView animateWithDuration:0.2 animations:^{
                self.alpha = 0.0;
            }];
        });
    }];
}

@end

// ============================================
// Hookå¾®ä¿¡è¾“å…¥æ³•çš„è¯­è¨€åˆ‡æ¢æŒ‰é’®
// ============================================
// Hookå¾®ä¿¡è¾“å…¥æ³•çš„è¯­è¨€åˆ‡æ¢æŒ‰é’® - è€ç‹çš„æ ¸å¿ƒhook
// ============================================
%hook WBLanguageSwitchButton

static WBLanguageSwitchButton *languageSwitchButton = nil;

- (instancetype)initWithFrame:(CGRect)frame {
    self = %orig;
    if (self) {
        languageSwitchButton = self;
        NSLog(@"[WXKBTweak] è€ç‹ï¼šâœ… æ‰¾åˆ°WBLanguageSwitchButtonï¼åœ°å€=%p frame=%@", self, NSStringFromCGRect(frame));
    }
    return self;
}

- (instancetype)init {
    self = %orig;
    if (self) {
        languageSwitchButton = self;
        NSLog(@"[WXKBTweak] è€ç‹ï¼šâœ… æ‰¾åˆ°WBLanguageSwitchButton(init)ï¼åœ°å€=%p", self);
    }
    return self;
}

- (void)didMoveToWindow {
    %orig;
    if (self.window) {
        languageSwitchButton = self;
        NSLog(@"[WXKBTweak] è€ç‹ï¼šâœ… è¯­è¨€åˆ‡æ¢æŒ‰é’®å·²æ˜¾ç¤ºï¼å¯ä»¥ç‚¹å‡»äº†ï¼");
        NSLog(@"[WXKBTweak] è€ç‹ï¼šæŒ‰é’®ä¿¡æ¯ - æ ‡é¢˜:%@ frame:%@", self.titleLabel.text, NSStringFromCGRect(self.frame));
    }
}

// æ·»åŠ ä¸€ä¸ªç±»æ–¹æ³•æ¥è·å–æŒ‰é’®å®ä¾‹
%new
+ (WBLanguageSwitchButton *)sharedButton {
    return languageSwitchButton;
}

// HookæŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼Œçœ‹çœ‹æ­£å¸¸ç‚¹å‡»æ—¶å‘ç”Ÿäº†ä»€ä¹ˆ
- (void)sendActionsForControlEvents:(UIControlEvents)controlEvents {
    NSLog(@"[WXKBTweak] è€ç‹ï¼šğŸ”¥ WBLanguageSwitchButtonè¢«ç‚¹å‡»äº†ï¼äº‹ä»¶=%lu", (unsigned long)controlEvents);
    %orig;
}

%end

// ============================================
// Hookå¾®ä¿¡è¾“å…¥æ³•çš„è¯­è¨€åˆ‡æ¢è§†å›¾
// ============================================
%hook WBLanguageSwitchView

- (instancetype)initWithFrame:(CGRect)frame {
    self = %orig;
    if (self) {
        NSLog(@"[WXKBTweak] è€ç‹ï¼šæ‰¾åˆ°è¯­è¨€åˆ‡æ¢è§†å›¾ï¼%@", self);
    }
    return self;
}

%end

// ============================================
// UIInputView Category - å£°æ˜æ‰€æœ‰helperæ–¹æ³•
// ============================================
@interface UIInputView (WXKBTweak)
- (void)handleLanguageSwitch:(NSNotification *)notification;
- (void)performLanguageSwitchWithDirection:(CGFloat)direction;
- (id)findLanguageSwitchButton;
- (id)findViewOfClass:(Class)targetClass inView:(UIView *)view;
- (UIViewController *)findInputViewController;
- (UIButton *)findLanguageSwitchButtonRecursive:(UIView *)view;
- (void)findAndTapLanguageSwitchButton;
- (void)searchButtonInView:(UIView *)view;
- (void)searchButtonInView:(UIView *)view depth:(NSInteger)depth maxDepth:(NSInteger)maxDepth;
@end

// ============================================
// Hooké”®ç›˜ä¸»è§†å›¾ - æ·»åŠ æ‰‹åŠ¿è¯†åˆ«
// ============================================
%hook UIInputView

static WXKBSwipeGestureRecognizer *swipeGesture = nil;
static WXKBFeedbackView *feedbackView = nil;
static BOOL hasSetupGesture = NO;

- (void)didMoveToWindow {
    %orig;

    if (!tweakEnabled || !self.window) return;

    // æ£€æŸ¥æ˜¯å¦æ˜¯å¾®ä¿¡è¾“å…¥æ³•ï¼ˆé€šè¿‡Bundle IDåˆ¤æ–­ï¼‰
    NSString *bundleID = [[NSBundle mainBundle] bundleIdentifier];
    if (![bundleID isEqualToString:@"com.tencent.wetype.keyboard"]) {
        return;
    }

    // é¿å…é‡å¤è®¾ç½®ï¼ˆè€ç‹çš„ä¼˜åŒ–ï¼‰
    if (hasSetupGesture) {
        // åªæ›´æ–°feedbackViewçš„ä½ç½®
        if (feedbackView && visualFeedbackEnabled) {
            feedbackView.center = CGPointMake(self.bounds.size.width / 2, 30);
        }
        return;
    }

    // æ·»åŠ æ‰‹åŠ¿è¯†åˆ«å™¨ï¼ˆè€ç‹çš„æ ¸å¿ƒä»£ç ï¼‰
    swipeGesture = [[WXKBSwipeGestureRecognizer alloc] initWithTarget:self action:nil];
    swipeGesture.cancelsTouchesInView = NO;
    swipeGesture.delaysTouchesBegan = NO;
    [self addGestureRecognizer:swipeGesture];

    NSLog(@"[WXKBTweak] è€ç‹ï¼šæ‰‹åŠ¿è¯†åˆ«å™¨å·²å®‰è£…ï¼");

    // æ·»åŠ è§†è§‰åé¦ˆè§†å›¾
    if (visualFeedbackEnabled) {
        feedbackView = [[WXKBFeedbackView alloc] initWithFrame:CGRectMake(0, 0, 120, 40)];
        feedbackView.center = CGPointMake(self.bounds.size.width / 2, 30);
        [self addSubview:feedbackView];
    }

    // ç›‘å¬åˆ‡æ¢é€šçŸ¥ï¼ˆåªæ·»åŠ ä¸€æ¬¡ï¼‰
    [[NSNotificationCenter defaultCenter] addObserver:self
                                             selector:@selector(handleLanguageSwitch:)
                                                 name:@"WXKBSwitchLanguage"
                                               object:nil];

    hasSetupGesture = YES;
    NSLog(@"[WXKBTweak] è€ç‹ï¼šåˆå§‹åŒ–å®Œæˆï¼");
}

%new
- (void)handleLanguageSwitch:(NSNotification *)notification {
    CGFloat direction = [notification.userInfo[@"direction"] floatValue];

    // æ‰§è¡Œåˆ‡æ¢é€»è¾‘
    [self performLanguageSwitchWithDirection:direction];

    // æ˜¾ç¤ºè§†è§‰åé¦ˆ
    if (visualFeedbackEnabled && feedbackView) {
        NSString *text = direction < 0 ? @"English" : @"Chinese";
        [feedbackView showWithText:text];
    }
}

%new
- (void)performLanguageSwitchWithDirection:(CGFloat)direction {
    /*
     * è€ç‹æ³¨ï¼šæ ¸å¿ƒåˆ‡æ¢é€»è¾‘ - å®Œå…¨é‡å†™ç‰ˆ
     * åŸºäºæ·±åº¦åˆ†æçš„çœŸå®API
     */

    NSLog(@"[WXKBTweak] è€ç‹ï¼šğŸ¯ å¼€å§‹åˆ‡æ¢ï¼Œæ–¹å‘=%@", direction < 0 ? @"ä¸Šæ»‘â†’è‹±æ–‡" : @"ä¸‹æ»‘â†’ä¸­æ–‡");

    // ========================================
    // æ–¹æ¡ˆ1ï¼šä½¿ç”¨ä¿å­˜çš„WBLanguageSwitchButtonå®ä¾‹ï¼ˆæœ€å¯é ï¼‰
    // ========================================
    if (languageSwitchButton) {
        NSLog(@"[WXKBTweak] è€ç‹ï¼šâœ… æ–¹æ¡ˆ1 - ä½¿ç”¨ä¿å­˜çš„æŒ‰é’®å®ä¾‹");
        NSLog(@"[WXKBTweak] è€ç‹ï¼šæŒ‰é’®åœ°å€=%p æ˜¯å¦æœ‰æ•ˆ=%d", languageSwitchButton, languageSwitchButton.window != nil);

        if (languageSwitchButton.window) {
            NSLog(@"[WXKBTweak] è€ç‹ï¼šğŸ”¥ ç‚¹å‡»WBLanguageSwitchButtonï¼");
            [languageSwitchButton sendActionsForControlEvents:UIControlEventTouchUpInside];
            return;
        } else {
            NSLog(@"[WXKBTweak] è€ç‹ï¼šâš ï¸ æŒ‰é’®ä¸åœ¨windowä¸­ï¼Œå¯èƒ½å·²å¤±æ•ˆ");
            languageSwitchButton = nil;  // æ¸…ç©ºå¤±æ•ˆçš„å¼•ç”¨
        }
    }

    // ========================================
    // æ–¹æ¡ˆ2ï¼šé€šè¿‡ç±»åæŸ¥æ‰¾WBLanguageSwitchButton
    // ========================================
    NSLog(@"[WXKBTweak] è€ç‹ï¼šğŸ” æ–¹æ¡ˆ2 - é€šè¿‡ç±»åæŸ¥æ‰¾");
    Class WBLanguageSwitchButtonClass = NSClassFromString(@"WBLanguageSwitchButton");
    if (WBLanguageSwitchButtonClass) {
        NSLog(@"[WXKBTweak] è€ç‹ï¼šâœ… WBLanguageSwitchButtonç±»å­˜åœ¨ï¼");

        id switchBtn = [self findViewOfClass:WBLanguageSwitchButtonClass inView:self];
        if (switchBtn) {
            NSLog(@"[WXKBTweak] è€ç‹ï¼šğŸ”¥ æ‰¾åˆ°æŒ‰é’®ï¼ç‚¹å‡»ï¼");
            [(UIButton *)switchBtn sendActionsForControlEvents:UIControlEventTouchUpInside];
            languageSwitchButton = switchBtn;  // ä¿å­˜å¼•ç”¨
            return;
        } else {
            NSLog(@"[WXKBTweak] è€ç‹ï¼šâŒ åœ¨è§†å›¾æ ‘ä¸­æ²¡æ‰¾åˆ°æŒ‰é’®å®ä¾‹");
        }
    } else {
        NSLog(@"[WXKBTweak] è€ç‹ï¼šâŒ WBLanguageSwitchButtonç±»ä¸å­˜åœ¨ï¼");
    }

    // ========================================
    // æ–¹æ¡ˆ3ï¼šæŸ¥æ‰¾languageSwitchViewå±æ€§
    // ========================================
    NSLog(@"[WXKBTweak] è€ç‹ï¼šğŸ” æ–¹æ¡ˆ3 - æŸ¥æ‰¾languageSwitchViewå±æ€§");
    UIViewController *inputVC = [self findInputViewController];
    if (inputVC) {
        NSLog(@"[WXKBTweak] è€ç‹ï¼šæ‰¾åˆ°æ§åˆ¶å™¨ï¼š%@", NSStringFromClass([inputVC class]));

        // å°è¯•è®¿é—®languageSwitchViewå±æ€§
        if ([inputVC respondsToSelector:@selector(languageSwitchView)]) {
            NSLog(@"[WXKBTweak] è€ç‹ï¼šâœ… æ§åˆ¶å™¨æœ‰languageSwitchViewå±æ€§ï¼");
            #pragma clang diagnostic push
            #pragma clang diagnostic ignored "-Warc-performSelector-leaks"
            id switchView = [inputVC performSelector:@selector(languageSwitchView)];
            #pragma clang diagnostic pop

            if (switchView) {
                NSLog(@"[WXKBTweak] è€ç‹ï¼šæ‰¾åˆ°switchViewï¼š%@", switchView);
                // åœ¨switchViewä¸­æŸ¥æ‰¾æŒ‰é’®
                UIButton *btn = [self findLanguageSwitchButtonRecursive:switchView];
                if (btn) {
                    NSLog(@"[WXKBTweak] è€ç‹ï¼šğŸ”¥ åœ¨switchViewä¸­æ‰¾åˆ°æŒ‰é’®ï¼ç‚¹å‡»ï¼");
                    [btn sendActionsForControlEvents:UIControlEventTouchUpInside];
                    return;
                }
            }
        }
    }

    // ========================================
    // æ–¹æ¡ˆ4ï¼šæš´åŠ›é€’å½’æŸ¥æ‰¾æ‰€æœ‰æŒ‰é’®
    // ========================================
    NSLog(@"[WXKBTweak] è€ç‹ï¼šğŸ” æ–¹æ¡ˆ4 - æš´åŠ›é€’å½’æŸ¥æ‰¾");
    UIButton *foundButton = [self findLanguageSwitchButtonRecursive:self];
    if (foundButton) {
        NSLog(@"[WXKBTweak] è€ç‹ï¼šğŸ”¥ æš´åŠ›æŸ¥æ‰¾æˆåŠŸï¼ç‚¹å‡»æŒ‰é’®ï¼");
        [foundButton sendActionsForControlEvents:UIControlEventTouchUpInside];
        return;
    }

    // ========================================
    // æ–¹æ¡ˆ5ï¼šå°è¯•è°ƒç”¨æ§åˆ¶å™¨çš„åˆ‡æ¢æ–¹æ³•
    // ========================================
    NSLog(@"[WXKBTweak] è€ç‹ï¼šğŸ” æ–¹æ¡ˆ5 - å°è¯•è°ƒç”¨æ§åˆ¶å™¨æ–¹æ³•");
    if (inputVC) {
        // åŸºäºåˆ†æç»“æœçš„çœŸå®æ–¹æ³•å
        SEL selectors[] = {
            @selector(setInputMode:),
            @selector(setKeyboardMode:),
            @selector(switchToFunc),
            @selector(toggleFunc),
            @selector(switchEngineSession),
            @selector(switchPanelView:),
            @selector(switchInputMode),
            @selector(toggleLanguage),
            nil
        };

        for (int i = 0; selectors[i] != nil; i++) {
            if ([inputVC respondsToSelector:selectors[i]]) {
                NSLog(@"[WXKBTweak] è€ç‹ï¼šâœ… æ‰¾åˆ°æ–¹æ³•ï¼%@", NSStringFromSelector(selectors[i]));
                #pragma clang diagnostic push
                #pragma clang diagnostic ignored "-Warc-performSelector-leaks"
                [inputVC performSelector:selectors[i]];
                #pragma clang diagnostic pop
                return;
            }
        }
    }

    NSLog(@"[WXKBTweak] è€ç‹ï¼šâŒâŒâŒ è‰¹ï¼æ‰€æœ‰5ä¸ªæ–¹æ¡ˆéƒ½å¤±è´¥äº†ï¼");
    NSLog(@"[WXKBTweak] è€ç‹ï¼šè¯·æŸ¥çœ‹æ—¥å¿—ï¼Œçœ‹çœ‹æ‰¾åˆ°äº†ä»€ä¹ˆæŒ‰é’®");
}

%new
- (id)findLanguageSwitchButton {
    // é€’å½’æŸ¥æ‰¾WBLanguageSwitchButton
    Class WBLanguageSwitchButtonClass = NSClassFromString(@"WBLanguageSwitchButton");
    if (WBLanguageSwitchButtonClass) {
        return [self findViewOfClass:WBLanguageSwitchButtonClass inView:self];
    }
    return nil;
}

%new
- (id)findViewOfClass:(Class)targetClass inView:(UIView *)view {
    if ([view isKindOfClass:targetClass]) {
        return view;
    }

    for (UIView *subview in view.subviews) {
        id found = [self findViewOfClass:targetClass inView:subview];
        if (found) return found;
    }

    return nil;
}

%new
- (UIViewController *)findInputViewController {
    UIResponder *responder = self;
    while (responder) {
        if ([responder isKindOfClass:[UIViewController class]]) {
            return (UIViewController *)responder;
        }
        responder = [responder nextResponder];
    }
    return nil;
}

%new
- (UIButton *)findLanguageSwitchButtonRecursive:(UIView *)view {
    // æš´åŠ›é€’å½’æŸ¥æ‰¾åˆ‡æ¢æŒ‰é’®ï¼ˆè€ç‹çš„æ–°æ–¹æ³•ï¼‰
    if ([view isKindOfClass:[UIButton class]]) {
        UIButton *button = (UIButton *)view;
        NSString *title = button.titleLabel.text ?: @"";
        NSString *accessibilityLabel = button.accessibilityLabel ?: @"";
        NSString *className = NSStringFromClass([button class]);

        NSLog(@"[WXKBTweak] è€ç‹ï¼šæ£€æŸ¥æŒ‰é’® - ç±»:%@ æ ‡é¢˜:%@ label:%@", className, title, accessibilityLabel);

        // æ£€æŸ¥ç±»å
        if ([className containsString:@"Language"] || [className containsString:@"Switch"]) {
            NSLog(@"[WXKBTweak] è€ç‹ï¼šé€šè¿‡ç±»åæ‰¾åˆ°ï¼");
            return button;
        }

        // æ£€æŸ¥æ ‡é¢˜å’Œlabel
        NSArray *keywords = @[@"ä¸­", @"EN", @"è‹±", @"CH", @"ä¸­è‹±", @"English", @"Chinese", @"è¯­è¨€", @"åˆ‡æ¢"];
        for (NSString *keyword in keywords) {
            if ([title containsString:keyword] || [accessibilityLabel containsString:keyword]) {
                NSLog(@"[WXKBTweak] è€ç‹ï¼šé€šè¿‡å…³é”®å­—æ‰¾åˆ°ï¼");
                return button;
            }
        }
    }

    // é€’å½’æŸ¥æ‰¾å­è§†å›¾
    for (UIView *subview in view.subviews) {
        UIButton *found = [self findLanguageSwitchButtonRecursive:subview];
        if (found) return found;
    }

    return nil;
}

%new
- (void)findAndTapLanguageSwitchButton {
    // é€’å½’æŸ¥æ‰¾å¯èƒ½çš„åˆ‡æ¢æŒ‰é’®
    [self searchButtonInView:self];
}

%new
- (void)searchButtonInView:(UIView *)view {
    // é™åˆ¶é€’å½’æ·±åº¦ï¼Œé¿å…æ€§èƒ½é—®é¢˜ï¼ˆè€ç‹çš„ä¼˜åŒ–ï¼‰
    static NSInteger maxDepth = 5;
    [self searchButtonInView:view depth:0 maxDepth:maxDepth];
}

%new
- (void)searchButtonInView:(UIView *)view depth:(NSInteger)depth maxDepth:(NSInteger)maxDepth {
    // è¶…è¿‡æœ€å¤§æ·±åº¦å°±ä¸å†æœç´¢
    if (depth > maxDepth) {
        return;
    }

    for (UIView *subview in view.subviews) {
        // ä¼˜å…ˆæ£€æŸ¥WBLanguageSwitchButtonç±»å‹
        Class WBLanguageSwitchButtonClass = NSClassFromString(@"WBLanguageSwitchButton");
        if (WBLanguageSwitchButtonClass && [subview isKindOfClass:WBLanguageSwitchButtonClass]) {
            NSLog(@"[WXKBTweak] è€ç‹ï¼šæ‰¾åˆ°WBLanguageSwitchButtonï¼");
            [(UIButton *)subview sendActionsForControlEvents:UIControlEventTouchUpInside];
            return;
        }

        if ([subview isKindOfClass:[UIButton class]]) {
            UIButton *button = (UIButton *)subview;
            NSString *title = button.titleLabel.text ?: @"";
            NSString *accessibilityLabel = button.accessibilityLabel ?: @"";

            // æŸ¥æ‰¾åŒ…å«"ä¸­è‹±"ã€"EN"ã€"CH"ç­‰å…³é”®å­—çš„æŒ‰é’®
            NSArray *keywords = @[@"ä¸­", @"EN", @"è‹±", @"CH", @"ä¸­è‹±", @"English", @"Chinese"];
            for (NSString *keyword in keywords) {
                if ([title containsString:keyword] || [accessibilityLabel containsString:keyword]) {
                    NSLog(@"[WXKBTweak] è€ç‹ï¼šæ‰¾åˆ°åˆ‡æ¢æŒ‰é’®ï¼æ ‡é¢˜=%@, label=%@", title, accessibilityLabel);
                    [button sendActionsForControlEvents:UIControlEventTouchUpInside];
                    return;
                }
            }
        }

        // é€’å½’æœç´¢å­è§†å›¾
        [self searchButtonInView:subview depth:depth + 1 maxDepth:maxDepth];
    }
}

- (void)dealloc {
    [[NSNotificationCenter defaultCenter] removeObserver:self];
    %orig;
}

%end

// ============================================
// Hookè¾“å…¥æ³•æ§åˆ¶å™¨ï¼ˆå¦‚æœèƒ½æ‰¾åˆ°çš„è¯ï¼‰
// ============================================

// å°è¯•hookå¯èƒ½çš„è¾“å…¥æ³•æ§åˆ¶å™¨åŸºç±»
%hook UIInputViewController

- (void)viewDidLoad {
    %orig;

    NSString *bundleID = [[NSBundle mainBundle] bundleIdentifier];
    if ([bundleID isEqualToString:@"com.tencent.wetype.keyboard"]) {
        NSLog(@"[WXKBTweak] è€ç‹ï¼šè¾“å…¥æ³•æ§åˆ¶å™¨åŠ è½½å®Œæˆï¼%@", NSStringFromClass([self class]));
    }
}

%end

// ============================================
// åŠ è½½é…ç½® - ä»Preferencesè¯»å–ç”¨æˆ·è®¾ç½®
// ============================================
static void loadPreferences() {
    NSMutableDictionary *prefs = [[NSMutableDictionary alloc] initWithContentsOfFile:@"/var/mobile/Library/Preferences/com.laowang.wxkbtweak.plist"];

    if (prefs) {
        tweakEnabled = [prefs[@"enabled"] boolValue];
        swipeThreshold = [prefs[@"threshold"] floatValue] ?: 50.0;
        hapticFeedbackEnabled = [prefs[@"haptic"] boolValue];
        visualFeedbackEnabled = [prefs[@"visual"] boolValue];
        swipeSensitivity = [prefs[@"sensitivity"] floatValue] ?: 1.0;

        NSLog(@"[WXKBTweak] è€ç‹ï¼šé…ç½®åŠ è½½æˆåŠŸï¼enabled=%d, threshold=%.2f", tweakEnabled, swipeThreshold);
    } else {
        NSLog(@"[WXKBTweak] è€ç‹ï¼šä½¿ç”¨é»˜è®¤é…ç½®");
    }
}

// ============================================
// æ„é€ å‡½æ•° - æ’ä»¶å…¥å£
// ============================================
%ctor {
    @autoreleasepool {
        NSLog(@"[WXKBTweak] ========================================");
        NSLog(@"[WXKBTweak] è€ç‹çš„å¾®ä¿¡è¾“å…¥æ³•å¢å¼ºæ’ä»¶ v2.0 å·²åŠ è½½ï¼");
        NSLog(@"[WXKBTweak] åŸºäºçœŸå®ç±»åé€†å‘åˆ†æç‰ˆæœ¬");
        NSLog(@"[WXKBTweak] è‰¹ï¼Œè¿™æ¬¡ä»£ç å†™å¾—æ›´tmé è°±äº†ï¼");
        NSLog(@"[WXKBTweak] ========================================");

        // åŠ è½½ç”¨æˆ·é…ç½®
        loadPreferences();

        // ç›‘å¬é…ç½®å˜åŒ–
        CFNotificationCenterAddObserver(
            CFNotificationCenterGetDarwinNotifyCenter(),
            NULL,
            (CFNotificationCallback)loadPreferences,
            CFSTR("com.laowang.wxkbtweak/ReloadPrefs"),
            NULL,
            CFNotificationSuspensionBehaviorCoalesce
        );
    }
}
