name: Build Rootless DEB

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build DEB for arm64 & arm64e
    runs-on: macos-14
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache Theos
        uses: actions/cache@v4
        with:
          path: |
            ${{ github.workspace }}/theos
            ~/Library/Caches/Homebrew
          key: ${{ runner.os }}-theos-${{ hashFiles('**/Makefile') }}
          restore-keys: |
            ${{ runner.os }}-theos-

      - name: Install dependencies
        run: |
          brew install ldid

      - name: Setup Theos
        timeout-minutes: 15
        run: |
          echo "Setting up Theos..."
          
          # Set Theos path
          THEOS_PATH="${{ github.workspace }}/theos"
          echo "THEOS=$THEOS_PATH" >> $GITHUB_ENV
          
          # Check if Theos is already cached
          if [ -d "$THEOS_PATH" ]; then
            echo "âœ… Theos found in cache"
          else
            echo "ðŸ“¥ Installing Theos from scratch..."
            git clone --recursive https://github.com/theos/theos.git "$THEOS_PATH"
          fi

      - name: Download and install iOS SDK
        timeout-minutes: 10
        run: |
          echo "Downloading iOS SDK..."
          cd $THEOS/sdks
          
          # Check if SDK already exists
          if [ -d "iPhoneOS16.5.sdk" ]; then
            echo "âœ… SDK found in cache"
          else
            echo "ðŸ“¥ Downloading iOS 16.5 SDK..."
            curl -LO https://github.com/theos/sdks/archive/master.zip
            unzip -q master.zip
            mv sdks-master/* .
            rm -rf sdks-master master.zip
          fi
          
          ls -la
          echo "âœ… SDK installation completed"

      - name: Verify Theos installation
        run: |
          echo "Checking Theos installation..."
          if [ -z "$THEOS" ]; then
            echo "âŒ THEOS environment variable not set"
            exit 1
          fi
          echo "âœ… THEOS: $THEOS"
          ls -la $THEOS/ || true
          echo "Checking SDKs..."
          ls -la $THEOS/sdks/ || true

      - name: Configure build environment
        run: |
          echo "Setting up build environment..."
          export THEOS_PACKAGE_SCHEME=rootless
          export ARCHS="arm64 arm64e"
          echo "THEOS_PACKAGE_SCHEME=rootless" >> $GITHUB_ENV
          echo "ARCHS=arm64 arm64e" >> $GITHUB_ENV
          echo "Build environment configured:"
          echo "  THEOS: $THEOS"
          echo "  SDK_PATH: $SDK_PATH"
          echo "  ARCHS: arm64 arm64e"

      - name: Build main tweak
        timeout-minutes: 10
        run: |
          echo "Building WXKBTweak main tweak..."
          make clean || true
          make package FINALPACKAGE=1
          echo "âœ… Main tweak build completed"

      - name: Build preferences bundle
        timeout-minutes: 10
        run: |
          echo "Building WXKBTweakPrefs bundle..."
          cd wxkbtweakprefs
          make clean || true
          make package FINALPACKAGE=1
          cd ..
          echo "âœ… Preferences bundle build completed"

      - name: List generated artifacts
        if: always()
        run: |
          echo "Generated DEB files:"
          find . -name "*.deb" -type f -exec ls -lh {} \;
          echo ""
          echo "Package structure:"
          ls -la packages/ 2>/dev/null || echo "No packages directory found"

      - name: Upload artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: WXKBTweak-deb-packages
          path: |
            packages/*.deb
          retention-days: 30
          if-no-files-found: error

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: packages/*.deb
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build summary
        if: always()
        run: |
          echo "=========================================="
          echo "Build Summary"
          echo "=========================================="
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Event: ${{ github.event_name }}"
          echo "Runner: ${{ runner.os }}-${{ runner.arch }}"
          echo "=========================================="
