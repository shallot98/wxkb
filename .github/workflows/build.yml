name: Build WXKBTweak

# è€çŽ‹çš„è‡ªåŠ¨ç¼–è¯‘é…ç½® - è‰¹ï¼Œè¿™é…ç½®å†™å¾—çœŸtmä¸“ä¸šï¼

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    name: Build iOS Tweak
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkoutä»£ç 
      uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: ðŸ”§ å®‰è£…ä¾èµ–
      run: |
        echo "è€çŽ‹ï¼šå¼€å§‹å®‰è£…ä¾èµ–..."
        sudo apt-get update
        sudo apt-get install -y \
          curl \
          git \
          perl \
          clang \
          build-essential \
          fakeroot

    - name: ðŸ“¦ å®‰è£…Theos
      run: |
        echo "è€çŽ‹ï¼šå®‰è£…Theos..."
        export THEOS=/opt/theos
        sudo git clone --recursive https://github.com/theos/theos.git $THEOS
        sudo chown -R $(whoami):$(whoami) $THEOS

        # è®¾ç½®çŽ¯å¢ƒå˜é‡
        echo "THEOS=$THEOS" >> $GITHUB_ENV
        echo "$THEOS/bin" >> $GITHUB_PATH

    - name: ðŸ“± å®‰è£…iOS SDK
      run: |
        echo "è€çŽ‹ï¼šä¸‹è½½iOS SDK..."
        cd $THEOS
        curl -LO https://github.com/theos/sdks/archive/master.zip
        unzip master.zip
        mv sdks-master/iPhoneOS*.sdk sdks/
        rm -rf sdks-master master.zip

        echo "è€çŽ‹ï¼šSDKå®‰è£…å®Œæˆï¼"
        ls -la $THEOS/sdks/

    - name: ðŸ”¨ ç¼–è¯‘ä¸»æ’ä»¶
      run: |
        echo "è€çŽ‹ï¼šå¼€å§‹ç¼–è¯‘ä¸»æ’ä»¶..."
        cd $GITHUB_WORKSPACE

        # æ˜¾ç¤ºçŽ¯å¢ƒä¿¡æ¯
        echo "THEOS=$THEOS"
        echo "å·¥ä½œç›®å½•: $(pwd)"

        # æ¸…ç†å¹¶ç¼–è¯‘
        make clean || true
        make package FINALPACKAGE=1

        echo "è€çŽ‹ï¼šä¸»æ’ä»¶ç¼–è¯‘å®Œæˆï¼"

    - name: ðŸŽ¨ ç¼–è¯‘è®¾ç½®é¢æ¿
      run: |
        echo "è€çŽ‹ï¼šç¼–è¯‘è®¾ç½®é¢æ¿..."
        cd $GITHUB_WORKSPACE/wxkbtweakprefs

        make clean || true
        make package FINALPACKAGE=1

        echo "è€çŽ‹ï¼šè®¾ç½®é¢æ¿ç¼–è¯‘å®Œæˆï¼"
        cd ..

    - name: ðŸ“‹ æ”¶é›†ç¼–è¯‘äº§ç‰©
      run: |
        echo "è€çŽ‹ï¼šæ”¶é›†ç¼–è¯‘äº§ç‰©..."
        mkdir -p build_output

        # å¤åˆ¶debåŒ…
        find packages -name "*.deb" -exec cp {} build_output/ \;

        # ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨
        ls -lh build_output/ > build_output/FILES.txt

        # ç”Ÿæˆæž„å»ºä¿¡æ¯
        cat > build_output/BUILD_INFO.txt << EOF
        ========================================
        WXKBTweak æž„å»ºä¿¡æ¯
        ========================================

        æž„å»ºæ—¶é—´: $(date)
        Gitæäº¤: ${{ github.sha }}
        Gitåˆ†æ”¯: ${{ github.ref }}
        æž„å»ºè€…: GitHub Actions

        è€çŽ‹æé†’ï¼š
        - è¿™æ˜¯è‡ªåŠ¨ç¼–è¯‘çš„debåŒ…
        - å¯ä»¥ç›´æŽ¥å®‰è£…åˆ°rootlessè¶Šç‹±è®¾å¤‡
        - å®‰è£…åŽè®°å¾—é‡å¯SpringBoard

        è‰¹ï¼Œè‡ªåŠ¨ç¼–è¯‘çœŸtmæ–¹ä¾¿ï¼
        ========================================
        EOF

        echo "è€çŽ‹ï¼šç¼–è¯‘äº§ç‰©æ”¶é›†å®Œæˆï¼"
        cat build_output/BUILD_INFO.txt

    - name: ðŸ“¤ ä¸Šä¼ ç¼–è¯‘äº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: WXKBTweak-${{ github.sha }}
        path: build_output/
        retention-days: 30

    - name: ðŸŽ‰ åˆ›å»ºReleaseï¼ˆä»…tagè§¦å‘ï¼‰
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: build_output/*.deb
        body: |
          ## WXKBTweak ${{ github.ref_name }}

          ### ðŸ“¦ å®‰è£…æ–¹æ³•

          ```bash
          # ä¸‹è½½debåŒ…åˆ°è®¾å¤‡
          scp com.laowang.wxkbtweak_*.deb root@è®¾å¤‡IP:/tmp/

          # SSHè¿žæŽ¥è®¾å¤‡
          ssh root@è®¾å¤‡IP

          # å®‰è£…
          dpkg -i /tmp/com.laowang.wxkbtweak_*.deb

          # é‡å¯SpringBoard
          sbreload
          ```

          ### âœ¨ åŠŸèƒ½ç‰¹æ€§
          - ä¸Šä¸‹æ»‘åŠ¨åˆ‡æ¢ä¸­è‹±æ–‡
          - éœ‡åŠ¨åé¦ˆ
          - è§†è§‰æç¤º
          - çµæ•åº¦å¯è°ƒ

          ### ðŸ“ æ›´æ–°å†…å®¹
          æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)

          ---
          *è€çŽ‹å‡ºå“ Â· GitHub Actionsè‡ªåŠ¨æž„å»º*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: âœ… æž„å»ºå®Œæˆ
      run: |
        echo "=========================================="
        echo "âœ… è€çŽ‹ï¼šæž„å»ºå®Œæˆï¼"
        echo "=========================================="
        echo ""
        echo "ç”Ÿæˆçš„æ–‡ä»¶ï¼š"
        ls -lh build_output/
        echo ""
        echo "è€çŽ‹æé†’ï¼š"
        echo "1. debåŒ…åœ¨Artifactsä¸­ä¸‹è½½"
        echo "2. å¦‚æžœæ˜¯tagï¼Œä¼šè‡ªåŠ¨åˆ›å»ºRelease"
        echo "3. ç›´æŽ¥å®‰è£…åˆ°rootlessè¶Šç‹±è®¾å¤‡"
        echo ""
        echo "è‰¹ï¼ŒGitHub ActionsçœŸtmå¥½ç”¨ï¼"
