name: Build Rootless DEB (Manual Theos Setup)

on:
  workflow_dispatch:

jobs:
  build:
    name: Build DEB with Manual Theos Setup
    runs-on: macos-14
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache Theos and SDKs
        uses: actions/cache@v4
        with:
          path: |
            /opt/theos
            ~/theos
          key: ${{ runner.os }}-theos-manual-${{ hashFiles('**/Makefile') }}
          restore-keys: |
            ${{ runner.os }}-theos-manual-

      - name: Install Theos manually
        timeout-minutes: 15
        run: |
          echo "Installing Theos manually..."
          
          # Check if Theos is already cached
          if [ -d "/opt/theos" ]; then
            echo "âœ… Theos found in cache"
            export THEOS=/opt/theos
          else
            echo "ðŸ“¥ Installing Theos from scratch..."
            sudo mkdir -p /opt/theos
            sudo chown -R $(whoami):staff /opt/theos
            
            # Clone Theos
            git clone --recursive https://github.com/theos/theos.git /opt/theos
            export THEOS=/opt/theos
          fi
          
          echo "THEOS=/opt/theos" >> $GITHUB_ENV
          echo "PATH=/opt/theos/bin:$PATH" >> $GITHUB_ENV

      - name: Download and install iOS SDK
        timeout-minutes: 10
        run: |
          echo "Downloading iOS SDK..."
          cd $THEOS/sdks
          
          # Check if SDK already exists
          if [ -d "iPhoneOS16.5.sdk" ]; then
            echo "âœ… SDK found in cache"
          else
            # Download iOS 16.5 SDK
            curl -LO https://github.com/theos/sdks/archive/master.zip
            unzip -q master.zip
            mv sdks-master/* .
            rm -rf sdks-master master.zip
          fi
          
          ls -la
          echo "âœ… SDK installation completed"

      - name: Verify Theos installation
        run: |
          echo "Checking Theos installation..."
          echo "THEOS: $THEOS"
          ls -la $THEOS/ || true
          echo ""
          echo "Checking SDKs..."
          ls -la $THEOS/sdks/ || true
          echo ""
          echo "Checking Theos version..."
          cat $THEOS/.theos_version || echo "No version file"

      - name: Configure build environment
        run: |
          echo "Setting up build environment..."
          export THEOS_PACKAGE_SCHEME=rootless
          export ARCHS="arm64 arm64e"
          echo "THEOS_PACKAGE_SCHEME=rootless" >> $GITHUB_ENV
          echo "ARCHS=arm64 arm64e" >> $GITHUB_ENV
          echo "Build environment configured:"
          echo "  THEOS: $THEOS"
          echo "  ARCHS: arm64 arm64e"

      - name: Build main tweak
        timeout-minutes: 10
        run: |
          echo "Building WXKBTweak main tweak..."
          make clean || true
          make package FINALPACKAGE=1
          echo "âœ… Main tweak build completed"

      - name: Build preferences bundle
        timeout-minutes: 10
        run: |
          echo "Building WXKBTweakPrefs bundle..."
          cd wxkbtweakprefs
          make clean || true
          make package FINALPACKAGE=1
          cd ..
          echo "âœ… Preferences bundle build completed"

      - name: List generated artifacts
        if: always()
        run: |
          echo "Generated DEB files:"
          find . -name "*.deb" -type f -exec ls -lh {} \;
          echo ""
          echo "Package structure:"
          ls -la packages/ 2>/dev/null || echo "No packages directory found"

      - name: Upload artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: WXKBTweak-deb-packages-manual
          path: |
            packages/*.deb
          retention-days: 30
          if-no-files-found: error

      - name: Build summary
        if: always()
        run: |
          echo "=========================================="
          echo "Build Summary"
          echo "=========================================="
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Event: ${{ github.event_name }}"
          echo "Runner: ${{ runner.os }}-${{ runner.arch }}"
          echo "=========================================="
